<html xmlns:th="http://www.thymeleaf.org">
<body>
	<div th:fragment="list" class="card shadow-sm mt-4">
		<div class="card-header bg-light">
			<h4 class="mb-0">Đánh giá & Bình luận</h4>
		</div>
		<div class="card-body">
			<div th:if="${#lists.isEmpty(reviews)}"
				class="text-center text-muted py-3">
				<p>Chưa có đánh giá nào cho sản phẩm này.</p>
			</div>
			<div th:unless="${#lists.isEmpty(reviews)}">
				<div th:each="review : ${reviews}" class="border-bottom mb-3 pb-3">
					<div class="d-flex">
						<img
							th:src="${review.nguoiDung.avatar != null} ? @{'/images/avatar/' + ${review.nguoiDung.avatar}} : @{'/images/avatar/defaultAvatar.jpg'}"
							class="rounded-circle me-3" alt="Avatar" width="50" height="50"
							style="object-fit: cover;">
						<div class="flex-grow-1">
							<div class="d-flex justify-content-between">
								<h6 class="fw-bold mb-0" th:text="${review.nguoiDung.hoTen}">Tên
									người dùng</h6>
								<small class="text-muted"
									th:text="${#temporals.format(review.ngayTao, 'dd/MM/yyyy')}"></small>
							</div>
							<div class="mb-2">
								<span th:each="i : ${#numbers.sequence(1, 5)}"
									class="text-warning" th:text="${i <= review.soSao} ? '★' : '☆'"></span>
							</div>
							<p th:text="${review.noiDung}">Nội dung bình luận.</p>

							<!-- ✅ Đặt phản hồi ở đây, ngay sau phần nội dung -->
							<div th:if="${!#lists.isEmpty(review.traLois)}"
								class="mt-3 ms-5 p-3 bg-light rounded border-start border-3 border-primary">
								<h6 class="text-muted mb-2">Phản hồi từ quản trị viên:</h6>
								<div th:each="reply : ${review.traLois}" class="mb-2">
									<p class="mb-1">
										<strong
											th:text="${reply.nguoiDung != null ? reply.nguoiDung.hoTen : 'Quản trị viên'}"></strong>:
										<span th:text="${reply.noiDung}"></span>
									</p>
									<small class="text-secondary"
										th:text="${#temporals.format(reply.ngayTao, 'dd/MM/yyyy HH:mm')}"></small>
								</div>
							</div>


							<th:block
								th:with="mediaList=${#strings.arraySplit(review.mediaUrls, ';')}">
								<div th:each="mediaFile : ${mediaList}">
									<img
										th:if="${#strings.endsWith(mediaFile.toLowerCase(), '.png') or #strings.endsWith(mediaFile.toLowerCase(), '.jpg') or #strings.endsWith(mediaFile.toLowerCase(), '.jpeg')}"
										th:src="@{'/uploads/' + ${mediaFile}}"
										class="img-fluid rounded"
										style="height: 80px; width: 80px; object-fit: cover;">
									<video
										th:if="${#strings.endsWith(mediaFile.toLowerCase(), '.mp4') or #strings.endsWith(mediaFile.toLowerCase(), '.mov')}"
										controls class="img-fluid rounded"
										style="max-height: 80px; max-width: 150px;">
										<source th:src="@{'/uploads/' + ${mediaFile}}">
									</video>
								</div>
							</th:block>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>
</body>
</html>