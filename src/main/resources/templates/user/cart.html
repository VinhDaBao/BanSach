<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layout/base::layout(~{::title}, ~{::section})}">
<head>
<meta charset="UTF-8">
<title th:fragment="title" th:text="${pageTitle}">Gi·ªè h√†ng</title>
</head>
<body>
	<section th:fragment="section">
		<div class="container py-5">
			<div th:if="${success}"
				class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle me-2"></i> <span th:text="${success}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"
					aria-label="Close"></button>
			</div>

			<div th:if="${error}"
				class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="fas fa-exclamation-triangle me-2"></i> <span
					th:text="${error}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"
					aria-label="Close"></button>
			</div>
			<div class="row">
				<!-- C·ªôt tr√°i: s·∫£n ph·∫©m -->
				<div class="col-lg-8 mb-4">
					<div class="card shadow-sm">
						<div class="card-body">
							<h4 class="mb-3">S·∫£n ph·∫©m trong gi·ªè</h4>

							<!-- N·∫øu gi·ªè tr·ªëng -->
							<div th:if="${#lists.isEmpty(cartItems)}"
								class="text-center text-muted py-5">Gi·ªè h√†ng tr·ªëng. H√£y
								th√™m s√°ch b·∫°n mu·ªën mua!</div>

							<!-- N·∫øu c√≥ s·∫£n ph·∫©m -->
							<div th:if="${!#lists.isEmpty(cartItems)}">
								<div th:each="item : ${cartItems}"
									class="d-flex border-bottom py-3 cart-item-row">
									<div class="me-3" style="width: 80px; height: 100px;">
										<img
											th:if="${item.imageUrl != null && !item.imageUrl.isEmpty()}"
											th:src="@{'/uploads/' + ${item.imageUrl}}"
											th:alt="${item.title}" class="img-fluid rounded shadow-sm"
											style="width: 100%; height: 100%; object-fit: cover;">
										<div
											th:if="${item.imageUrl == null || item.imageUrl.isEmpty()}"
											class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center h-100">
											<i class="fas fa-book fa-2x text-muted"></i>
										</div>
									</div>
									<div class="flex-grow-1">
										<p class="fw-semibold mb-1" th:text="${item.title}">T√™n
											s√°ch</p>
										<small class="text-muted d-block mb-2"
											th:text="${item.author}">T√°c gi·∫£</small>
										<div class="mb-2">
											<span th:if="${item.hasDiscount != null && item.hasDiscount}">
												<del class="text-muted me-2 small price-per-unit-original"
													th:text="${#numbers.formatDecimal(item.originalPrice, 0, 'POINT', 0, 'POINT')} + ' ‚Ç´'">150.000
													‚Ç´</del> <span class="fw-bold text-success price-per-unit"
												th:text="${#numbers.formatDecimal(item.price, 0, 'POINT', 0, 'POINT')} + ' ‚Ç´'">120.000
													‚Ç´</span>
											</span> <span
												th:unless="${item.hasDiscount != null && item.hasDiscount}">
												<span class="fw-bold price-per-unit"
												th:text="${#numbers.formatDecimal(item.price, 0, 'POINT', 0, 'POINT')} + ' ‚Ç´'">120.000
													‚Ç´</span>
											</span>
										</div>

										<div class="d-flex justify-content-between align-items-center">
											<div class="d-flex align-items-center gap-2">
												<input type="checkbox" name="selectedItems"
													th:value="${item.id}"
													th:checked="${selectedItems != null and selectedItems.contains(item.id)}"
													class="me-2 item-checkbox">
												<div class="input-group input-group-sm"
													style="width: 120px;">
													<button class="btn btn-outline-secondary btn-decrease"
														type="button" th:attr="data-book-id=${item.id}">-</button>
													<input type="number"
														class="form-control text-center quantity-input"
														th:value="${item.quantity}"
														th:attr="data-book-id=${item.id}, data-max-stock=${item.stock}"
														min="1">
													<button class="btn btn-outline-secondary btn-increase"
														type="button" th:attr="data-book-id=${item.id}">+</button>
												</div>
												<form th:action="@{/cart/remove}" method="post"
													style="display: inline;">
													<input type="hidden" name="id" th:value="${item.id}">
													<button type="submit" class="btn btn-link text-danger p-0">X√≥a</button>
												</form>
											</div>
											<div class="fw-bold item-total-price"
												th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'POINT', 0, 'POINT')} + ' ‚Ç´'">
												0 ‚Ç´</div>
											<!-- Gi√° g·ªëc ·∫©n ƒë·ªÉ JS t√≠nh to√°n -->
											<span class="d-none item-price-value"
												th:text="${#numbers.formatDecimal(item.price, 0, 'NONE', 0, 'NONE')}">0</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- C·ªôt ph·∫£i: T√≥m t·∫Øt ƒë∆°n h√†ng -->
				<div class="col-lg-4">
					<div class="card shadow-sm">
						<div class="card-body">
							<h5 class="mb-3">T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
							<div class="d-flex justify-content-between mb-2">
								<span>T·∫°m t√≠nh</span> <strong id="subtotal-value">0 ‚Ç´</strong>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<span>Ph√≠ v·∫≠n chuy·ªÉn</span> <span id="shipping-value">0.000
									‚Ç´</span>
							</div>
							<hr>
							<div class="d-flex justify-content-between mb-3">
								<span class="fw-bold">T·ªïng c·ªông</span> <strong class="fs-5"
									id="grandtotal-value">30.000 ‚Ç´</strong>
							</div>

							<form th:action="@{/checkout}" method="post" id="checkout-form">
								<button type="submit" class="btn btn-success w-100"
									onclick="return prepareCheckout()">Thanh to√°n</button>
							</form>
						</div>
						<!--  ƒê·ªäA CH·ªà GIAO H√ÄNG -->
						<div class="card shadow-sm mb-3">
							<div class="card-body">
								<div
									class="d-flex justify-content-between align-items-center mb-3">
									<h5 class="mb-0">ƒê·ªãa ch·ªâ giao h√†ng</h5>
									<a th:href="@{/user/addresses}"
										class="btn btn-sm btn-outline-primary"> <i
										class="fas fa-cog"></i> Qu·∫£n l√Ω
									</a>
								</div>

								<!-- N·∫øu ch∆∞a c√≥ ƒë·ªãa ch·ªâ -->
								<div th:if="${#lists.isEmpty(addresses)}"
									class="text-center py-3">
									<i class="fas fa-map-marker-alt fa-2x text-muted mb-2"></i>
									<p class="text-muted mb-2">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng</p>
									<a th:href="@{/user/addresses/add}"
										class="btn btn-sm btn-primary"> <i class="fas fa-plus"></i>
										Th√™m ƒë·ªãa ch·ªâ
									</a>
								</div>

								<!-- N·∫øu c√≥ ƒë·ªãa ch·ªâ -->
								<div th:if="${!#lists.isEmpty(addresses)}">
									<select class="form-select" id="selected-address"
										name="selectedAddress" required>
										<option value="">-- Ch·ªçn ƒë·ªãa ch·ªâ --</option>
										<option th:each="addr : ${addresses}" th:value="${addr.id}"
											th:selected="${defaultAddress != null && addr.id == defaultAddress.id}"
											th:text="${addr.hoTen} + ' - ' + ${addr.sdt} + ' - ' + ${addr.diaChiChiTiet}">
										</option>
									</select>

									<!-- Hi·ªÉn th·ªã chi ti·∫øt ƒë·ªãa ch·ªâ ƒë√£ ch·ªçn -->
									<div id="address-detail" class="mt-3 p-3 bg-light rounded"
										style="display: none;">
										<p class="mb-1">
											<strong id="addr-name"></strong>
										</p>
										<p class="mb-1">
											<i class="fas fa-phone"></i> <span id="addr-phone"></span>
										</p>
										<p class="mb-0">
											<i class="fas fa-map-marker-alt"></i> <span id="addr-full"></span>
										</p>
									</div>

									<a th:href="@{/user/addresses/add}"
										class="btn btn-sm btn-link mt-2"> <i class="fas fa-plus"></i>
										Th√™m ƒë·ªãa ch·ªâ m·ªõi
									</a>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<!-- ========== SCRIPT ƒê·∫∂T ·ªû CU·ªêI SECTION ========== -->
		<script th:inline="javascript">
        /*<![CDATA[*/
        console.log('‚úì Cart script loaded!');
        
        // H√†m format s·ªë th√†nh ti·ªÅn VN
        function formatCurrency(number) {
            return number.toLocaleString('vi-VN') + ' ‚Ç´';
        }

        // H√†m parse ti·ªÅn VN v·ªÅ s·ªë
        function parseCurrency(text) {
            return parseFloat(text.replace(/[^\d]/g, '')) || 0;
        }

        // H√†m c·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        function updateSubtotal() {
            let subtotal = 0;
            const rows = document.querySelectorAll('.cart-item-row');
            
            console.log('Updating subtotal, found', rows.length, 'items');
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.item-checkbox');
                if (checkbox && checkbox.checked) {
                    const priceValue = parseCurrency(row.querySelector('.item-price-value').textContent);
                    const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                    const itemTotal = priceValue * quantity;
                    subtotal += itemTotal;
                    
                    console.log('Item checked - Price:', priceValue, 'Qty:', quantity, 'Total:', itemTotal);
                    
                    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn t·ª´ng item
                    const itemTotalElement = row.querySelector('.item-total-price');
                    itemTotalElement.textContent = formatCurrency(itemTotal);
                }
            });

            const shipping = 0;
            const discount = 0;
            const grandTotal = subtotal + shipping - discount;

            document.getElementById('subtotal-value').textContent = formatCurrency(subtotal);
            document.getElementById('grandtotal-value').textContent = formatCurrency(grandTotal);
            
            console.log('‚úì Updated - Subtotal:', subtotal, 'GrandTotal:', grandTotal);
        }

        // H√†m g·ª≠i AJAX ƒë·ªÉ update quantity
        function updateQuantityOnServer(bookId, quantity) {
            const formData = new URLSearchParams();
            formData.append('maSach', bookId);
            formData.append('quantity', quantity);

            console.log('‚Üí Sending update request - BookId:', bookId, 'Quantity:', quantity);

            fetch('/cart/update-quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                console.log('‚Üê Response status:', response.status);
                if (response.ok) {
                    console.log('‚úì Update successful');
                    updateSubtotal();
                } else {
                    console.error('‚úó Update failed, status:', response.status);
                    return response.text().then(text => {
                        console.error('Error message:', text);
                        alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng: ' + text);
                    });
                }
            })
            .catch(error => {
                console.error('‚úó Fetch error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng!');
            });
        }

        // H√†m tƒÉng s·ªë l∆∞·ª£ng
        function increaseQuantity(button) {
            const bookId = button.getAttribute('data-book-id');
            const input = button.parentElement.querySelector('.quantity-input');
            const maxStock = parseInt(input.getAttribute('data-max-stock')) || 1;
            let quantity = parseInt(input.value) || 1;
            if (quantity < maxStock) {
                quantity += 1;
                input.value = quantity;
                updateQuantityOnServer(bookId, quantity);
            } else {
                alert('Kh√¥ng ƒë·ªß h√†ng trong kho! (T·ªìn: ' + maxStock + ')');
            }
        }

        // H√†m gi·∫£m s·ªë l∆∞·ª£ng
        function decreaseQuantity(button) {
            const bookId = button.getAttribute('data-book-id');
            const input = button.parentElement.querySelector('.quantity-input');
            let quantity = parseInt(input.value) || 1;
            if (quantity > 1) {
                quantity -= 1;
                input.value = quantity;
                
                console.log('‚ûñ Decrease - BookId:', bookId, 'New quantity:', quantity);
                updateQuantityOnServer(bookId, quantity);
            } else {
                console.log('‚ö† Cannot decrease below 1');
            }
        }

     // C·∫≠p nh·∫≠t h√†m prepareCheckout()
        function prepareCheckout() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
                return false;
            }
            
            // ‚≠ê KI·ªÇM TRA ƒê·ªäA CH·ªà
            const selectedAddress = document.getElementById('selected-address');
            if (selectedAddress && !selectedAddress.value) {
                alert('Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng!');
                return false;
            }
            
            const form = document.getElementById('checkout-form');
            
            // X√≥a c√°c hidden input c≈©
            form.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());
            
            // Th√™m selectedItems v√† quantities
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('.cart-item-row');
                const bookId = checkbox.value;
                const quantity = row.querySelector('.quantity-input').value;
                
                const inputItem = document.createElement('input');
                inputItem.type = 'hidden';
                inputItem.name = 'selectedItems';
                inputItem.value = bookId;
                form.appendChild(inputItem);
                
                const inputQty = document.createElement('input');
                inputQty.type = 'hidden';
                inputQty.name = 'quantities';
                inputQty.value = quantity;
                form.appendChild(inputQty);
            });
            
            // ‚≠ê TH√äM ƒê·ªäA CH·ªà
            if (selectedAddress && selectedAddress.value) {
                const inputAddr = document.createElement('input');
                inputAddr.type = 'hidden';
                inputAddr.name = 'addressId';
                inputAddr.value = selectedAddress.value;
                form.appendChild(inputAddr);
            }
            
            console.log('‚úì Checkout prepared with address:', selectedAddress ? selectedAddress.value : 'none');
            return true;
        }
        // ========== KH·ªûI T·∫†O KHI TRANG LOAD ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Cart page initialized');
            
            // G·∫Øn s·ª± ki·ªán cho n√∫t tƒÉng/gi·∫£m
            document.querySelectorAll('.btn-increase').forEach(btn => {
                btn.addEventListener('click', function() {
                    increaseQuantity(this);
                });
            });
            
            document.querySelectorAll('.btn-decrease').forEach(btn => {
                btn.addEventListener('click', function() {
                    decreaseQuantity(this);
                });
            });
            
            // G·∫Øn s·ª± ki·ªán cho checkbox
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSubtotal);
            });
            
            // G·∫Øn s·ª± ki·ªán cho form checkout
            document.getElementById('checkout-form').addEventListener('submit', function(e) {
			    if (!prepareCheckout()) {
			        e.preventDefault();
			    }
			});
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('input', function () {
                    const maxStock = parseInt(this.getAttribute('data-max-stock')) || 1;
                    let quantity = parseInt(this.value) || 1;

                    // N·∫øu v∆∞·ª£t qu√° t·ªìn kho
                    if (quantity > maxStock) {
                        alert('Kh√¥ng ƒë·ªß h√†ng trong kho! (T·ªìn: ' + maxStock + ')');
                        quantity = maxStock;
                        this.value = quantity;
                    }

                    // C·∫≠p nh·∫≠t server
                    const bookId = this.getAttribute('data-book-id');
                    updateQuantityOnServer(bookId, quantity);
                });
            });
            updateSubtotal();
        });
        /*]]>*/
    </script>
	</section>
</body>
</html>