<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layout/base::layout(~{::title}, ~{::section})}">
<head>
<meta charset="UTF-8">
<title th:fragment="title" th:text="${pageTitle} ?: 'Chi tiết sản phẩm'">Chi
	tiết sản phẩm</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
	crossorigin="anonymous">
<link th:href="@{/css/style.css}" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
	rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<style>
.error {
	color: red;
}

.success {
	color: green;
}
</style>
</head>
<body>
	<section>
		<div class="container-fluid mt-1">
			<div class="row">
				<!-- Cột trái: Danh sách thể loại -->
				<div class="col-md-2">
					<div class="card shadow-sm p-0 mb-5 bg-body-tertiary rounded">
						<div class="card-body">
							<div class="list-group">
								<a th:href="@{/products}"
									class="list-group-item list-group-item-action"
									th:classappend="${selectedCategoryId == null} ? 'active'">
									Tất cả sản phẩm </a> <a th:each="theLoai : ${listTheLoai}"
									th:href="@{'/products/category/' + ${theLoai.id}}"
									class="list-group-item list-group-item-action"
									th:text="${theLoai.tenTL}"
									th:classappend="${selectedCategoryId != null and theLoai.id == selectedCategoryId} ? 'active'">
									Tên thể loại </a>
							</div>
						</div>
					</div>
				</div>

				<!-- Cột phải: Chi tiết sản phẩm -->
				<div class="col-md-10">
					<!-- Hiển thị thông báo lỗi nếu có -->
					<div th:if="${param.error != null}" class="alert alert-danger">
						<span th:text="${error ?: 'Đã xảy ra lỗi.'}"></span>
					</div>

					<!-- Card thông tin sản phẩm -->
					<div class="card shadow-sm mb-4">
						<div class="card-body">
							<h1 class="fs-3 text-center mb-4" th:text="${sach.tenSP}">Chi
								tiết sản phẩm</h1>
							<div class="row">
								<!-- Cột trái: Hình ảnh + Card đánh giá -->
								<div class="col-md-4">
									<!-- Hình ảnh sách -->
									<div class="position-relative">
										<div th:if="${sach.badgeDiscount != null}"
											class="position-absolute top-0 start-0 m-2 z-10">
											<span class="badge bg-danger fs-6 fw-bold"> SALE <span
												th:text="${sach.badgeDiscount}">20% OFF</span>
											</span>
										</div>
										<img class="card-img-top rounded mb-4" th:src="@{${sach.anh}}"
											alt="Hình ảnh sách"
											style="max-height: 400px; object-fit: cover;">
									</div>

									<!-- Card đánh giá -->
									<div class="card border-0 bg-light">
										<div class="card-body p-3">
											<h6 class="fw-bold mb-3">Đánh giá sản phẩm</h6>
											<div class="text-center mb-3">
												<div class="mb-2">
													<span class="fs-2 fw-bold text-warning"
														th:text="${#numbers.formatDecimal(ratingStats.averageRating, 1, 1)}">0</span>
													<span class="fs-5 text-muted">/5</span>
												</div>
												<div class="mb-2">
													<span th:with="avg=${ratingStats.averageRating}"
														class="text-warning" style="font-size: 1.3rem;"> <i
														th:each="i : ${#numbers.sequence(1, 5)}"
														th:class="${i <= avg} ? 'fas fa-star' : (${i - 0.5 <= avg} ? 'fas fa-star-half-alt' : 'far fa-star')"></i>
													</span>
												</div>
												<p class="text-muted small mb-0"
													th:text="'(' + ${ratingStats.totalRatings} + ' đánh giá)'">(0
													đánh giá)</p>
											</div>
											<div class="mb-2">
												<div class="d-flex align-items-center mb-1">
													<span class="me-2 small" style="min-width: 45px;">5
														sao</span>
													<div class="progress flex-grow-1 me-2" style="height: 8px;">
														<div class="progress-bar bg-warning" role="progressbar"
															th:style="'width: ' + ${ratingStats.ratingPercentages.getOrDefault(5, 0)} + '%;'"></div>
													</div>
													<span class="text-muted small"
														style="min-width: 30px; text-align: right;"
														th:text="${ratingStats.ratingPercentages.getOrDefault(5, 0)} + '%'">0%</span>
												</div>
												<div class="d-flex align-items-center mb-1">
													<span class="me-2 small" style="min-width: 45px;">4
														sao</span>
													<div class="progress flex-grow-1 me-2" style="height: 8px;">
														<div class="progress-bar bg-warning" role="progressbar"
															th:style="'width: ' + ${ratingStats.ratingPercentages.getOrDefault(4, 0)} + '%;'"></div>
													</div>
													<span class="text-muted small"
														th:text="${ratingStats.ratingPercentages.getOrDefault(4, 0)} + '%'">0%</span>
												</div>
												<div class="d-flex align-items-center mb-1">
													<span class="me-2 small" style="min-width: 45px;">3
														sao</span>
													<div class="progress flex-grow-1 me-2" style="height: 8px;">
														<div class="progress-bar bg-warning" role="progressbar"
															th:style="'width: ' + ${ratingStats.ratingPercentages.getOrDefault(3, 0)} + '%;'"></div>
													</div>
													<span class="text-muted small"
														th:text="${ratingStats.ratingPercentages.getOrDefault(3, 0)} + '%'">0%</span>
												</div>
												<div class="d-flex align-items-center mb-1">
													<span class="me-2 small" style="min-width: 45px;">2
														sao</span>
													<div class="progress flex-grow-1 me-2" style="height: 8px;">
														<div class="progress-bar bg-warning" role="progressbar"
															th:style="'width: ' + ${ratingStats.ratingPercentages.getOrDefault(2, 0)} + '%;'"></div>
													</div>
													<span class="text-muted small"
														th:text="${ratingStats.ratingPercentages.getOrDefault(2, 0)} + '%'">0%</span>
												</div>
												<div class="d-flex align-items-center mb-1">
													<span class="me-2 small" style="min-width: 45px;">1
														sao</span>
													<div class="progress flex-grow-1 me-2" style="height: 8px;">
														<div class="progress-bar bg-warning" role="progressbar"
															th:style="'width: ' + ${ratingStats.ratingPercentages.getOrDefault(1, 0)} + '%;'"></div>
													</div>
													<span class="text-muted small"
														th:text="${ratingStats.ratingPercentages.getOrDefault(1, 0)} + '%'">0%</span>
												</div>
											</div>
										</div>
									</div>

								</div>

								<!-- Cột phải: Thông tin sách -->
								<div class="col-md-8">
									<!-- Tên sách -->
									<h3 class="fw-bold mb-3 text-primary" th:text="${sach.tenSP}">Tên
										Sách</h3>

									<!-- Tác giả -->
									<p class="text-muted mb-2">
										<strong>Tác giả:</strong> <span
											th:text="${sach.tacGia != null ? sach.tacGia : '---'}"></span>
									</p>

									<!-- Thể loại -->
									<p class="mb-2">
										<strong>Thể loại:</strong> <span
											th:if="${sach.danhSachTheLoai != null}"> <span
											th:each="theLoai, iterStat : ${sach.danhSachTheLoai}"
											th:text="${theLoai.tenTL} + ${iterStat.last ? '' : ', '}"></span>
										</span> <span th:unless="${sach.danhSachTheLoai != null}">---</span>
									</p>

									<!-- Nhà xuất bản -->
									<p class="mb-2">
										<strong>Nhà xuất bản:</strong> <span
											th:text="${sach.nhaXB != null ? sach.nhaXB.tenNXB : '---'}"></span>
									</p>

									<!-- Hình thức -->
									<p class="mb-2">
										<strong>Hình thức:</strong> <span
											th:text="${sach.hinhThuc != null ? sach.hinhThuc.tenHT : '---'}"></span>
									</p>

									<!-- Số lượng tồn -->
									<p class="mb-2">
										<strong>Số lượng tồn:</strong> <span
											th:text="${sach.soLuongTon != null ? sach.soLuongTon : 0}"></span>
									</p>

									<!-- Ngày có hàng -->
									<p class="mb-2">
										<strong>Ngày có hàng:</strong> <span
											th:text="${sach.ngayCoHang != null ? #temporals.format(sach.ngayCoHang, 'dd/MM/yyyy HH:mm') : '---'}"></span>
									</p>

									<!-- Mô tả -->
									<p class="mb-3">
										<strong>Mô tả:</strong> <span
											th:text="${sach.moTa != null ? sach.moTa : 'Không có mô tả'}"></span>
									</p>

									<!-- Giá bán / Giá giảm -->
									<div class="mb-4">
										<div th:if="${sach.badgeDiscount != null}">
											<del class="fw-bold fs-5 text-secondary me-2"
												th:text="${#numbers.formatDecimal(sach.giaBan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
												Giá gốc </del>
											<span class="fw-bold fs-3 text-danger"
												th:text="${#numbers.formatDecimal(sach.giaGiam, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
												Giá giảm </span>
										</div>
										<div th:unless="${sach.badgeDiscount != null}">
											<p class="fw-bold fs-3 text-danger mb-0"
												th:text="${#numbers.formatDecimal(sach.giaBan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
												Giá bán</p>
										</div>
									</div>

									<!-- Form thêm vào giỏ hàng và nút viết đánh giá -->
									<form th:action="@{'/cart/add'}" method="post">
										<input type="hidden" name="userId"
											th:value="${session.userId ?: 1}" /> <input type="hidden"
											name="bookId" th:value="${sach.id}" />
										<div class="input-group mb-3" style="max-width: 200px;">
											<span class="input-group-text">Số lượng</span> <input
												type="number" name="quantity" value="1" min="1"
												th:max="${sach.soLuongTon}" class="form-control"
												th:disabled="${sach.soLuongTon == 0}" />
										</div>
										<div class="d-flex flex-wrap gap-2">
											<a
												th:href="@{/cart/add(maSach=${sach.id}, soLuong=${#strings.isEmpty(quantity) ? 1 : quantity}, userId=${session.userId}, returnUrl='/product-detail/' + ${sach.id})}"
												class="btn btn-primary btn-lg"
												th:disabled="${sach.soLuongTon == 0}"> <span
												th:if="${sach.soLuongTon == 0}">Hết hàng</span> <span
												th:unless="${sach.soLuongTon == 0}">Thêm vào giỏ hàng</span>
											</a> <a th:href="@{/products}"
												class="btn btn-outline-secondary btn-lg">Quay lại</a>
											<div th:if="${session.loggedUser == null}">
												<button type="button" class="btn btn-danger btn-lg"
													onclick="openReviewModal()">
													<i class="fas fa-pen me-1"></i> Viết đánh giá
												</button>
											</div>

											<!-- Trường hợp 2: Đã đăng nhập, chưa mua -->
											<div th:if="${session.loggedUser != null and !hasPurchased}">
												<button type="button" class="btn btn-secondary btn-lg"
													disabled>
													<i class="fas fa-lock me-1"></i> Viết đánh giá
												</button>
												<small class="text-danger d-block mt-2"> <i
													class="fas fa-exclamation-triangle"></i> Bạn cần mua sách
													 để đánh giá
												</small>
											</div>

											<!-- Trường hợp 3: Đã mua, đã đánh giá rồi -->
											<div
												th:if="${session.loggedUser != null and hasPurchased and hasReviewed}">
												<button type="button" class="btn btn-success btn-lg"
													disabled>
													<i class="fas fa-check me-1"></i> Đã đánh giá
												</button>
												<small class="text-success d-block mt-2"> <i
													class="fas fa-check-circle"></i> Bạn đã đánh giá sách này
												</small>
											</div>

											<!-- Trường hợp 4: Đã mua, chưa đánh giá - CHO PHÉP ĐÁNH GIÁ -->
											<div th:if="${session.loggedUser != null and canReview}">
												<button type="button" class="btn btn-danger btn-lg"
													onclick="openReviewModal()">
													<i class="fas fa-pen me-1"></i> Viết đánh giá
												</button>
												<small class="text-success d-block mt-2"> <i
													class="fas fa-check-circle"></i> Bạn đã mua sách này, hãy
													chia sẻ đánh giá nhé!
												</small>
											</div>
										</div>
									</form>

									<button type="button" class="btn btn-outline-danger btn-lg"
										onclick="toggleFavorite()"
										th:attr="data-book-id=${sach.id}, data-is-favorite=${sach.isFavorite ?: false}">
										<i
											th:class="${sach.isFavorite ? 'fas' : 'far'} + ' fa-heart me-1'"></i>
										<span
											th:text="${sach.isFavorite ? 'Đã yêu thích' : 'Yêu thích'}">Yêu
											thích</span>
									</button>

								</div>
								<div th:replace="~{fragments/review-list :: list}"></div>

							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:replace="~{fragments/review-modal :: modal}"></div>
		</div>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
			crossorigin="anonymous"></script>
		<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(event) {
            const sachId = this.dataset.sachId;
            const icon = this.querySelector('i');
            const isFavorite = icon.classList.contains('fas'); 
            fetch('/favorite/toggle/' + sachId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'  
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isFavorite) {
                        icon.classList.remove('fas', 'text-danger');
                        icon.classList.add('far', 'text-muted');
                        this.classList.remove('text-danger');
                        this.classList.add('text-muted');
                    } else {
                        icon.classList.remove('far', 'text-muted');
                        icon.classList.add('fas', 'text-danger');
                        this.classList.remove('text-muted');
                        this.classList.add('text-danger');
                    }
                } else if (data.message && data.message.includes('đăng nhập')) {
                    alert('Vui lòng đăng nhập để yêu thích sản phẩm.');
                    window.location.href = '/login';
                } else {
                    alert(data.message || 'Lỗi khi cập nhật yêu thích');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Lỗi kết nối, thử lại sau.');
            });
        });
    });
});
</script>
		<script
			src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
			integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
			crossorigin="anonymous"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
			integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
			crossorigin="anonymous"></script>
		<!-- ⭐ THÊM SCRIPT NÀY VÀO CUỐI FILE product-detail.html -->
		<script th:inline="javascript">
    /*<![CDATA[*/
    
    // ⭐ KIỂM TRA USER ĐÃ ĐĂNG NHẬP CHƯA
    const isLoggedIn = /*[[${session.loggedUser != null}]]*/ false;
    
    // Hàm mở modal viết đánh giá (kiểm tra đăng nhập)
    function openReviewModal() {
        if (!isLoggedIn) {
            if (confirm('Vui lòng đăng nhập để đánh giá. Bạn có muốn đăng nhập ngay không?')) {
                window.location.href = '/login';
            }
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
    }
    function toggleFavorite() {
        if (!isLoggedIn) {
            if (confirm('Vui lòng đăng nhập để yêu thích sản phẩm. Bạn có muốn đăng nhập ngay không?')) {
                window.location.href = '/login';
            }
            return;
        }
        
        const button = event.currentTarget;
        const bookId = button.getAttribute('data-book-id');
        const isFavorite = button.getAttribute('data-is-favorite') === 'true';
        
        fetch('/favorite/toggle/' + bookId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => {
            if (response.ok) {
                const icon = button.querySelector('i');
                const text = button.querySelector('span');
                
                if (isFavorite) {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    text.textContent = 'Yêu thích';
                    button.setAttribute('data-is-favorite', 'false');
                } else {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    text.textContent = 'Đã yêu thích';
                    button.setAttribute('data-is-favorite', 'true');
                }
            } else {
                alert('Có lỗi xảy ra. Vui lòng thử lại!');
            }
        })
        .catch(error => {
            alert('Có lỗi xảy ra: ' + error);
        });
    }
    
    
    // Hàm mở modal sửa đánh giá
    function openEditModal(button) {
        const reviewId = button.getAttribute('data-review-id');
        const rating = button.getAttribute('data-rating');
        const content = button.getAttribute('data-content');
        
        const modalElement = document.getElementById('editReviewModal');
        if (!modalElement) {
            alert('Không tìm thấy modal sửa đánh giá. Vui lòng tải lại trang!');
            return;
        }
        
        const reviewIdInput = document.getElementById('reviewId');
        const commentTextarea = document.getElementById('edit-comment');
        
        if (reviewIdInput) reviewIdInput.value = reviewId;
        if (commentTextarea) commentTextarea.value = content;
        
        const allRadios = modalElement.querySelectorAll('input[type="radio"][name="rating"]');
        allRadios.forEach(function(radio) {
            if (radio.value === rating) radio.checked = true;
        });
        
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('#reviewModal input[name="rating"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                updateRatingText('rating-text', this.value);
            });
        });
        
        document.querySelectorAll('#editReviewModal input[name="rating"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                updateRatingText('edit-rating-text', this.value);
            });
        });
    });
    
    function updateRatingText(elementId, rating) {
        const textMap = {
            '1': 'Rất tệ ⭐',
            '2': 'Tệ ⭐⭐',
            '3': 'Khá ⭐⭐⭐',
            '4': 'Tốt ⭐⭐⭐⭐',
            '5': 'Tuyệt vời ⭐⭐⭐⭐⭐'
        };
        
        const textElement = document.getElementById(elementId);
        if (textElement) {
            textElement.textContent = textMap[rating] || 'Chọn số sao để đánh giá';
        }
    }
    
    /*]]>*/
</script>
	</section>
</body>
</html>